<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="form.css" />
    <title>申請内容の入力</title>
</head>
<body>
    <div class="screen">
        <div class="view">
            <a href="home.html" class="tabler-caret-left"><img class="vector" src="img/vector.svg" alt="戻る" /></a>
            <a href="home.html" class="text-wrapper">戻る</a>
        </div>
        <div class="div">申請内容の入力</div>
    </div>

    <form id="dispatchForm">

        <!--
        <div class="item">
            <label class="label">住所 <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" name="address" required>
        </div>

        <div class="item">
            <label class="label">名前（団体名） <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" name="org_name" required>
        </div>

        <div class="item">
            <label class="label">担当者名</label>
            <input class="inputs" type="text" name="person_name">
        </div>

        <div class="item">
            <label class="label">電話番号 <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" name="tel" required>
        </div>

        <div class="item">
            <label class="label">FAX</label>
            <input class="inputs" type="text" name="fax">
        </div>
        -->

        <div class="item">
            <label class="label">利用日 <span class="required-mark">必須</span></label>
            <input class="inputs" type="date" name="dispatch_date" required>
        </div>

        <div class="item" style="display:flex; gap:12px; align-items:flex-start;">
            <div style="flex:1; min-width:0;">
                <label class="label">開始時刻 <span class="required-mark">必須</span></label>
                <input class="inputs" type="time" name="dispatch_start" required style="width:100%;">
            </div>
            <div style="flex:1; min-width:0;">
                <label class="label">終了時刻 <span class="required-mark">必須</span></label>
                <input class="inputs" type="time" name="dispatch_end" required style="width:100%;">
            </div>
        </div>

        <div class="item">
            <label class="label">郵便番号 <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" id="dest_zipcode" maxlength="8" placeholder="例：1234567" required>
        </div>

        <div class="item">
            <label class="label">利用先の住所 <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" name="dest_address" placeholder="例：北海道千歳市北栄1-1-1" required>
        </div>

        <div class="item">
            <label class="label">利用先の会場名 <span class="required-mark">必須</span></label>
            <input class="inputs" type="text" name="dest_place" placeholder="例：○○コミュニティセンター" required>
        </div>

        <div class="item">
            <label class="label">利用先の電話番号</label>
            <input class="inputs" type="text" name="dest_tel" placeholder="例：03-1234-5678">
        </div>

        <!--
        <div class="item">
            <label class="label">利用先のFAX</label>
            <input class="inputs" type="text" name="dest_fax">
        </div>
        -->

        <div class="item">
            <label class="label">申請事由 <span class="required-mark">必須</span></label>
            <textarea class="inputs" name="reason" placeholder="例：イベント開催のため" required></textarea>
        </div>

        <div class="btn-area">
            <button class="button" type="submit">送信</button>
        </div>
    </form>

    <script>
    // ページ読み込み時に編集モードかチェック
    window.addEventListener('load', function() {
        const editMode = sessionStorage.getItem('editMode');
        if (editMode === 'true') {
            // 編集モードの場合、既存データを復元
            restoreFormData();
            sessionStorage.removeItem('editMode');
        }
    });
    
    // フォームデータを復元する関数
    function restoreFormData() {
        const applicationData = JSON.parse(sessionStorage.getItem('applicationData') || '{}');
        const form = document.getElementById('dispatchForm');
        
        if (applicationData.dispatch_date) form.dispatch_date.value = applicationData.dispatch_date;
        if (applicationData.dispatch_start) form.dispatch_start.value = applicationData.dispatch_start;
        if (applicationData.dispatch_end) form.dispatch_end.value = applicationData.dispatch_end;
        if (applicationData.dest_zipcode) form.dest_zipcode.value = applicationData.dest_zipcode;
        if (applicationData.dest_address) form.dest_address.value = applicationData.dest_address;
        if (applicationData.dest_place) form.dest_place.value = applicationData.dest_place;
        if (applicationData.dest_tel) form.dest_tel.value = applicationData.dest_tel;
        if (applicationData.reason) form.reason.value = applicationData.reason;
    }
    
    // フォーム送信：/submit に POST
    document.getElementById('dispatchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.reportValidity(); return; }
        // フォームデータを収集してローカルストレージに保存
        const applicationData = {
            dispatch_date: form.dispatch_date.value,
            dispatch_start: form.dispatch_start.value,
            dispatch_end: form.dispatch_end.value,
            dest_zipcode: form.dest_zipcode.value,
            dest_address: form.dest_address.value,
            dest_place: form.dest_place.value,
            dest_tel: form.dest_tel.value,
            reason: form.reason.value
        };
        
        const formData = new FormData(form);
        fetch('/submit', { method: 'POST', body: formData })
        .then(response => {
            if (response.ok) {
                alert('申請を送信しました。');
                // データをセッションストレージに保存（ブラウザ閉じると自動削除）
                sessionStorage.setItem('applicationData', JSON.stringify(applicationData));
                // 申請完了後、home.htmlに戻る
                window.location.href = 'home.html';
            } else {
                alert('送信に失敗しました。');
            }
        })
        .catch(error => {
            alert('送信エラー: ' + error);
        });
    });

    // 郵便番号で派遣先住所を自動入力（zipcloud API）
    document.getElementById('dest_zipcode').addEventListener('blur', function() {
        const raw = this.value || '';
        const code = raw.replace(/\D/g, '').slice(0,7);
        if (code.length !== 7) return;
        fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + code)
        .then(res => res.json())
        .then(json => {
            if (json && json.status === 200 && json.results && json.results.length) {
                const r = json.results[0];
                const addr = `${r.address1 || ''}${r.address2 || ''}${r.address3 || ''}`;
                const addrInput = document.querySelector('input[name="dest_address"]');
                if (addrInput) addrInput.value = addr;
            } else {
                console.log('郵便番号で住所が見つかりませんでした');
            }
        })
        .catch(err => {
            console.log('住所自動入力エラー:', err);
        });
    });
    </script>
</body>
</html>